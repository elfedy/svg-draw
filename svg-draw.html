<html>
	<head>
		<meta charset="utf-8"/>
	</head>

	<body>
		<main>
			<div class="canvas-container">
				<svg version="1.1" 
					baseProfile="full" 
					width="500" 
					height="500"
					xmlns="http://www.w3.org/2000/svg"
					class="js-svg"
					>
					<rect height="100%" width="100%" fill="#fff"/>
				</svg>
			</div>
			<div class="controls">
				<div class="controls__grid">
					<button class="elem-button js-insert-rect">
						<svg height="30" width="30">
							<rect x="5" y="5" height="20" width="20" fill="transparent" stroke="black" stroke-width="1" />
						</svg>
					</button>
					<button class="elem-button js-insert-ellipse">
						<svg height="30" width="30">
							<ellipse cx="15" cy="15" rx="10" ry="10" fill="transparent" stroke="black" stroke-width="1" />
						</svg>
					</button>

					<label>Grid Size</label>
					<div class="controls__group">
						<label>x</label>
						<input class="js-size-x" type="number" min="0" max="1000" step="50" value="500"/>
					</div>
					<div class="controls__group">
						<label>y</label>
						<input class="js-size-y" type="number" min="0" max="1000" step="50" value="500" />
					</div>
				</div>
			</div>
		</main>
	</body>

	<script>
		// Main canvas and definitions

		let svg = document.querySelector('.js-svg');
		let svgns = "http://www.w3.org/2000/svg";

		// Controls

		let xSize = document.querySelector('.js-size-x');
		let ySize = document.querySelector('.js-size-y');
		let insertRect = document.querySelector('.js-insert-rect');
		let insertEllipseBtn = document.querySelector('.js-insert-ellipse');

		// Global State

		let currentElement = null;
		let isMovingElement = false;
		let movementInitCoords = null


		// Event listeners for controls

		document.body.addEventListener('click', handleUserClick);
		document.body.addEventListener('mousemove', handleUserMousemove);
		document.body.addEventListener('mouseup', handleUserMouseup);
		document.body.addEventListener('keypress', handleUserKeypress);

		xSize.addEventListener('change', (e) => svg.setAttribute('width', xSize.value));
		ySize.addEventListener('change', (e) => svg.setAttribute('height', ySize.value));
		insertRect.addEventListener('click', insertSquare);
		insertEllipseBtn.addEventListener('click', insertEllipse);

		// Insert elements

		function insertSquare() {
			let rect = document.createElementNS(svgns, 'rect');
			rect.setAttribute('height', '100');
			rect.setAttribute('width', '100');
			rect.setAttribute('x', '100');
			rect.setAttribute('y', '100');
			rect.setAttribute('fill', 'transparent');
			rect.setAttribute('stroke', 'black');
			rect.setAttribute('stroke-width', '1');
			rect.setAttribute('data-item', 'element');
			rect.class = 'svg-rect';


			svg.appendChild(rect);
		}

		function insertEllipse() {
			let elem = document.createElementNS(svgns, 'ellipse');
			elem.setAttribute('rx', '40');
			elem.setAttribute('ry', '40');
			elem.setAttribute('cx', '100');
			elem.setAttribute('cy', '100');
			elem.setAttribute('fill', 'transparent');
			elem.setAttribute('stroke', 'black');
			elem.setAttribute('stroke-width', '1');

			svg.appendChild(elem);
		}

		// Event handlers

		function handleUserKeypress(e) {
			if(currentElement !== null && e.charCode === 100) {
				removeElement(currentElement);
				currentElement = null;
				placeSelectBox();
			}
		}

		function handleUserClick(e) {
			let itemType = e.target.getAttribute('data-item') || null;
			switch(itemType) {
				case 'element':
					console.log('should run this');
					handleElementClick(e.target);
					break;
				
				case 'selector':
					break;

				default:
					// Deselect if target is not an item
					currentElement = null;
					placeSelectBox();
			}
		}

		function handleUserMousemove(e) {
			if(currentElement && isMovingElement) {
				movementInitCoords = movementInitCoords || {
					clientX: e.clientX, 
					clientY: e.clientY,
					elementX: parseInt(currentElement.getAttribute('x')),
					elementY: parseInt(currentElement.getAttribute('y')),
				};

				let diff = {
					x: e.clientX - movementInitCoords.clientX,
					y: e.clientY - movementInitCoords.clientX,
				}

				// Get new x/y values
				let borderWidth = parseInt(currentElement.getAttribute('stroke-width'));
				let minX = 0 + borderWidth;
				let maxX = parseInt(svg.getAttribute('width')) - borderWidth - movementInitCoords.elementX;
				let minY = 0 + borderWidth;
				let maxY = parseInt(svg.getAttribute('height')) - movementInitCoords.elementY - borderWidth;

				let targetX = movementInitCoords.elementX + diff.x;
				let newX = Math.min(maxX, Math.max(minX, targetX));
				let targetY = movementInitCoords.elementY + diff.y;
				let newY = Math.min(maxY, Math.max(minY, targetY));

				// Set new position
				currentElement.setAttribute('x', newX);
				currentElement.setAttribute('y', newY);

				placeSelectBox();
			}
		}

		function handleElementClick(element) {
			selectElement(element);	
		}

		function handleElementMousedown(e) {
			isMovingElement = true;
		}

		function handleUserMouseup(e) {
			isMovingElement = false;
			movingInitCoords = null;
		}

		// Actions

		function selectElement(element) {
			// Set current element
			currentElement = element;
			placeSelectBox();
		}

		function placeSelectBox() {
			if(currentElement) {
				// Get dimensions
				let padding = 20;
				let dimensions = currentElement.getBoundingClientRect();
				let boxX = dimensions.x - padding / 2;
				let boxY = dimensions.y - padding / 2;
				let boxWidth = dimensions.width + padding;
				let boxHeight = dimensions.height + padding;

				// Set styling
				let style = `
					width: ${boxWidth}px;
					height: ${boxHeight}px;
					border: 1px solid #0a84ff;
					background-color: transparent;
					position: absolute;
					z-index: 10;
					left: ${boxX}px;
					top: ${boxY}px;
				`

				
				let selectBox = document.querySelector('div[data-item="selector"]') || null;
				let selectBoxFound = selectBox ? true : false;
				selectBox = selectBox || document.createElement('div');

				selectBox.style = style;

				// init select box if not found
				if(!selectBoxFound) {
					selectBox.setAttribute('data-item', 'selector');
					selectBox.addEventListener('mousedown', handleElementMousedown);
					document.body.appendChild(selectBox);
				}
			} else {
				// Delete select box if found
				removeSelectBox()
			}
		}

		// Helpers
		function removeElement(element) {
			if(element) {
				element.parentNode.removeChild(element);
			}
		}

		function removeSelectBox() {
			let selectBox = document.querySelector('div[data-item="selector"]') || null;
			removeElement(selectBox);
		}

		// Debugging

		function logElementPosition(element, label) {
			let dimensions = element.getBoundingClientRect();
			console.log(`${label} x: ${dimensions.x}`);
			console.log(`${label} y: ${dimensions.y}`);
		}
	</script>

	<style>
		body {
			margin: 0;
			padding: 0;
			height: 100%;
			width: 100%;
		}

		main {
			height: 100vh;
			width: 100%;
			background-color: #eaeaea;
		}

		.canvas-container {
			position: absolute;
			top: 50px;
			left: 50px;
		}

		.controls {
			position: absolute;
			top: 50px;
			left: 1100px;
			display: flex;
			flex-direction: column;
			background-color: #fff;
			padding: 20px;
		}

		.controls__group {
			input {
				width: 50%;
			}
		}

		.elem-button {
			display: block;
			background-color: transparent;
			border: none;
			outline: none;
			cursor: pointer;
		}
	</style>
</html>
